{"version":3,"file":"client.js","sources":["webpack://a/webpack/runtime/rspack_version","webpack://a/webpack/runtime/rspack_unique_id","webpack://a/./src/mod/bb.ts","webpack://a/./src/main.ts"],"sourcesContent":["__webpack_require__.rv = () => (\"1.6.7\")","__webpack_require__.ruid = \"bundler=rspack@1.6.7\";","\r\nimport fragment_str from \"./bb.frag\";\r\nimport vertex_str from \"./bb.vert\";\r\n\r\nconst unwrap_gl2 = (canvas: OffscreenCanvas) => {\r\n    const gl = canvas.getContext(\"webgl2\");\r\n    if (!gl) throw new Error(\"inmyu gl2\");\r\n    return gl;\r\n};\r\nconst unwrap_ctx = (canvas: HTMLCanvasElement) => {\r\n    const ctx = canvas.getContext(\"2d\");\r\n    if (!ctx) throw new Error(\"inmyu ctx\");\r\n    return ctx;\r\n};\r\nconst unwrap_uloc = (gl: WebGL2RenderingContext, program: WebGLProgram, name: string) => {\r\n    const location = gl.getUniformLocation(program, name);\r\n    if (!location) throw new Error(\"inarigahaittenai\");\r\n    return location;\r\n}\r\nconst bracket = () => document.createElement(\"br\");\r\ntype InputCallback = (file: File) => void;\r\nclass InputContainer {\r\n    private parent = document.createElement(\"input\");\r\n    private callbacks: InputCallback[] = [];\r\n    constructor(append: Node) {\r\n        append.appendChild(this.parent);\r\n        this.initialize();\r\n    }\r\n    private initialize() {\r\n        this.parent.type = \"file\";\r\n        this.parent.addEventListener(\"input\", () => {\r\n\r\n            const file = this.parent.files?.item(0);\r\n            if (!file) {\r\n                alert(\"please select valid video file inmustonikisugiinn\");\r\n                return;\r\n            }\r\n\r\n            this.callback(file);\r\n            \r\n        });\r\n    }\r\n    bind_callback(callback: InputCallback) {\r\n        this.callbacks.push(callback);\r\n    }\r\n    private callback(file: File) {\r\n        for (const callback of this.callbacks) {\r\n            callback(file);\r\n        }\r\n    }\r\n}\r\nexport class ViewContainer {\r\n\r\n    private canvas = document.createElement(\"canvas\");\r\n    private ctx = unwrap_ctx(this.canvas);\r\n    private bb: BBContainer;\r\n    private delta_time = 0.0;\r\n    private time = 0.0;\r\n\r\n    private input: InputContainer;\r\n\r\n    constructor(append: Node) {\r\n        append.appendChild(this.canvas);\r\n        this.bb = new BBContainer(append);\r\n        append.appendChild(bracket());\r\n        this.input = new InputContainer(append);\r\n        this.initialize();\r\n    }\r\n    private initialize() {\r\n\r\n        this.canvas.width = 19;\r\n        this.canvas.height = 19;\r\n        this.canvas.addEventListener(\"contextlost\", () => {\r\n            alert(\"kbtit context lost\");\r\n            this.ctx = unwrap_ctx(this.canvas);\r\n        });\r\n\r\n        this.canvas.addEventListener(\"contextrestored\", () => {\r\n            alert(\"kbtit context restored\");\r\n        });\r\n\r\n        const bind = (time: number) => {\r\n            this.render(time);\r\n            requestAnimationFrame(bind);\r\n        };\r\n        requestAnimationFrame(bind);\r\n\r\n        this.input.bind_callback(async file => {\r\n            const [w, h] = await this.bb.bind_source(file);\r\n            this.canvas.width = w;\r\n            this.canvas.height = h;\r\n        });\r\n\r\n    }\r\n    render(time: number) {\r\n\r\n        this.delta_time = time - this.time;\r\n        this.time = time;\r\n\r\n        if (this.delta_time > 1000) {\r\n            console.warn(\"drop_warn\", this.delta_time);\r\n        }\r\n        const ctx = this.ctx;\r\n        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n        // ctx.fillStyle = \"#000\";\r\n        // ctx.globalAlpha = 1.0;\r\n        // ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);\r\n// \r\n        // ctx.fillText(this.delta_time.toString(), 0, 0);\r\n\r\n        const output = this.bb.write();\r\n\r\n        ctx.drawImage(output, 0, 0, this.canvas.width, this.canvas.height);\r\n\r\n    }\r\n}\r\nclass BBContainer {\r\n    private canvas = new OffscreenCanvas(1,1);\r\n    private gl = unwrap_gl2(this.canvas);\r\n    private video = document.createElement(\"video\");\r\n    private resolution!: WebGLUniformLocation;\r\n    private data!: WebGLUniformLocation;\r\n    private texture!: WebGLTexture;\r\n    constructor(append: Node) {\r\n        this.video.controls = true;\r\n        append.appendChild(this.video);\r\n        this.initialize();\r\n    }\r\n    private initialize() {\r\n        \r\n        this.canvas.addEventListener(\"contextlost\", () => {\r\n            alert(\"yjsnpi gl2 lost\");\r\n            this.gl = unwrap_gl2(this.canvas);\r\n        });\r\n\r\n        this.canvas.addEventListener(\"contextrestored\", () => {\r\n            alert(\"yjsnpi gl2 restored\");\r\n        });\r\n        this.gl_init();\r\n    }\r\n    private gl_init() {\r\n\r\n        const gl = this.gl;\r\n\r\n        const vertex = gl.createShader(gl.VERTEX_SHADER);\r\n        if (!vertex) throw new Error(\"verteeex\");\r\n\r\n        gl.shaderSource(vertex, vertex_str);\r\n        gl.compileShader(vertex);\r\n\r\n        const fragment = gl.createShader(gl.FRAGMENT_SHADER);\r\n        if (!fragment) throw new Error(\"fraaaa\");\r\n\r\n        gl.shaderSource(fragment, fragment_str);\r\n        gl.compileShader(fragment);\r\n\r\n        const program = gl.createProgram();\r\n        gl.attachShader(program, vertex);\r\n        gl.attachShader(program, fragment);\r\n        gl.linkProgram(program);\r\n        gl.useProgram(program);\r\n\r\n        const vao = gl.createVertexArray();\r\n\r\n        gl.bindVertexArray(vao);\r\n\r\n        const vbo = gl.createBuffer();\r\n\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, vbo);\r\n        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([\r\n            -1, -1,\r\n            1, -1,\r\n            -1, 1,\r\n            1, 1\r\n        ]), gl.STATIC_DRAW);\r\n\r\n        gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);\r\n        gl.enableVertexAttribArray(0);\r\n\r\n        const ibo = gl.createBuffer();\r\n\r\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibo);\r\n        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array([\r\n            0, 1, 2,\r\n            1, 2, 3\r\n        ]), gl.STATIC_DRAW);\r\n\r\n        this.resolution = unwrap_uloc(gl, program, \"resolution\");\r\n        this.data = unwrap_uloc(gl, program, \"data\");\r\n        this.texture = gl.createTexture();\r\n\r\n    }\r\n    async bind_source(source: MediaSource | Blob): Promise<[number,number]> {\r\n\r\n        return new Promise(res => {\r\n\r\n            const src = URL.createObjectURL(source);\r\n            this.video.src = src;\r\n\r\n            this.video.onloadedmetadata = () => {\r\n\r\n                const w = this.video.videoWidth;\r\n                const h = this.video.videoHeight;\r\n\r\n                this.canvas.width = w;\r\n                this.canvas.height = h;\r\n\r\n                const gl = this.gl;\r\n\r\n                gl.viewport(0, 0, w, h);\r\n                gl.uniform2f(this.resolution, w, h);\r\n                gl.uniform4f(this.data, 0, 0, w, h);\r\n\r\n                res([w, h]);\r\n\r\n            };\r\n\r\n        });\r\n\r\n    }\r\n    \r\n    write() {\r\n        const gl = this.gl;\r\n\r\n        gl.clearColor(0, 0, 0, 0);\r\n        gl.clear(gl.COLOR_BUFFER_BIT);\r\n        gl.enable(gl.BLEND);\r\n        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\r\n\r\n        gl.bindTexture(gl.TEXTURE_2D, this.texture);\r\n        gl.texImage2D(\r\n            gl.TEXTURE_2D,\r\n            0,\r\n            gl.RGBA,\r\n            gl.RGBA,\r\n            gl.UNSIGNED_BYTE,\r\n            this.video\r\n        );\r\n\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n\r\n        gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);\r\n        gl.flush();\r\n        return this.canvas;\r\n    }\r\n}","import { ViewContainer } from \"./mod/bb\";\n\nnew ViewContainer(document.body);"],"names":["unwrap_gl2","canvas","gl","Error","unwrap_ctx","ctx","unwrap_uloc","program","name","location","InputContainer","_this_parent_files","file","alert","callback","append","document","BBContainer","vertex","fragment","vao","vbo","Float32Array","ibo","Uint16Array","source","Promise","res","src","URL","w","h","OffscreenCanvas","bind","time","requestAnimationFrame","console","output"],"mappings":"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"}